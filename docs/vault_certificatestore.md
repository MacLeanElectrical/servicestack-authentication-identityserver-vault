# IdentityServer3.Contrib.Vault.CertificateStore

A plugin for [IdentityServer](https://identityserver.github.io/) that provides a Certificate Store using [Vault](https://www.vaultproject.io/).  The plugin implements the ISigningKeyService for retrieving X509 certificates generated by Vault for JwtToken signing.

## Overview
IdentityServer uses [X509 Certificates](https://identityserver.github.io/Documentation/docsv2/configuration/crypto.html) to sign the id_token issued by the [Authorization](https://identityserver.github.io/Documentation/docsv2/endpoints/authorization.html) endpoint. Vault can be configured to generate the X509 Certificates using the [PKI Secret Backend](https://www.vaultproject.io/docs/secrets/pki/index.html) used to sign these tokens in IdentityServer.
This provides an implementation of the ISigningKeyService interface that can be used to request Certificates from Vault then retrieve new ones when they have expired (provided Vault has an intermediate certificate uploaded).

IdentityServer must be able to retrieve the Certificates from Vault and therefore the [AppID Authentication Backend](https://www.vaultproject.io/docs/auth/app-id.html) has been used to authenticate Identity Server for Vault Access where a combination of a AppId and UserId token is used to obtain a "Vault Token".

#### Prerequisites
Vault is assumed to have been setup with the following backends:
* [App ID Auth Backend](https://www.vaultproject.io/docs/auth/app-id.html)
* [PKI Secret Backend](https://www.vaultproject.io/docs/secrets/pki/index.html)

#### Quick Start
To add this to the OWIN startup class of an IdentityServer instance add the following to the Configuration method:
<pre>
<code>
    public void Configuration(IAppBuilder app)
    {
        var factory = new IdentityServerServiceFactory();
        
        ...
        
        var options = new IdentityServerOptions
        {
            Factory = factory,
            ...  
        };

		options.AddVaultCertificateStore(new VaultCertificateStoreAppIdOptions
        {
			AppId = "146a3d05-2042-4855-93ba-1b122e70eb6d",									// AppId using Vault AppId Authentication
            UserId = "976c1095-a7b4-4b6f-8cd8-d71d860c6a31",								// UserId using Vault UserId Authentication
				
            RoleName = "identity-server",													// Vault Certificate Role Name
            CommonName = "idsvr.test.com"													// Vault Certificate Common Name
        });                              
        
        ...
        
        app.UseIdentityServer(options);
    }
</code>
</pre>